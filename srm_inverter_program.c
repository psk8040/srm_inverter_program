/*----------------------------------------------------------------------------------
-- Company: Hoshi Laboratory, Tokyo University of Science
-- Engineer: Takuya Iguchi
-- 
-- Create Date:		08/25/2013 
-- Design Name:		srm_inverter_program
-- Module Name:		
-- Project Name:	Doraemon
-- Target Devices:	PE-Expert3
-- Tool versions:	PE-View9
-- Description: 
-- 	
--	
----------------------------------------------------------------------------------*/
#include <mwio3.h>
#include <math.h>

#define		BDN				0					/*	ボードナンバー	*/

/*			小容量SRMベンチの固有値			*/
#define		POLE_NUMBER		4					/*	回転子極数	*/
#define		ENC_RESOLUT		4096				/*	エンコーダカウント値	*/

/*			システム変数			*/
int			Exp_start;							/*	実験開始	*/
int			system_status;
#define		STOP			0					/*	システムの状態が停止中	*/
#define		RUN				1					/*	システムの状態が実行中	*/
#define		ERROR			2					/*	システムの状態がエラー	*/
int			servo_status;
#define		SERVO_OFF		0
#define		SERVO_ON		1
int			drive_mode;
int			z_det;
int			z_det_comp;

/*			SRMボード変数			*/
#define		RANGE_U			250.
#define		RANGE_V			250.
#define		RANGE_W			250.
#define		OFFSET_U		0.
#define		OFFSET_V		0.
#define		OFFSET_W		0.
#define		NEG_VOLTAGE		0
#define		ZERO_VOLTAGE1	1
#define		ZERO_VOLTAGE2	2
#define		OVER_CURRENT_LEVEL		100.
float		hyswidth;
float		u_on;
float		u_off;
float		v_on;
float		v_off;
float		w_on;
float		w_off;


/*			エラー変数				*/
#define		OVER_CURRENT	1					/*	過電流状態	*/

/*			タイマー割り込み0(behavior)設定			*/
#define		TIC0			5					/*	タイマー割り込み周期	*/

/*			エンコーダ変数			*/
int			enc_cnt;							/*	エンコーダカウント値	*/
int			enc_cnt_a;							/*	A相のエンコーダカウント値	*/
int			enc_cnt_b;							/*	B相のエンコーダカウント値	*/
int			enc_cnt_c;							/*	C相のエンコーダカウント値	*/

/*			電流指令値変数			*/
float		i_ref;								/*	一括設定用の電流指令値	*/
float		ia_ref;								/*	A相の電流指令値	*/
float		ib_ref;								/*	B相の電流指令値	*/
float		ic_ref;								/*	C相の電流指令値	*/
//float		i_ideal[1024]=	{0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.02, 0.07, 0.12, 0.18, 0.23, 0.28, 0.33, 0.39, 0.44, 0.49, 0.54, 0.60, 0.65, 0.70, 0.76, 0.81, 0.86, 0.91, 0.97, 1.02, 1.07, 1.13, 1.18, 1.23, 1.28, 1.34, 1.39, 1.44, 1.49, 1.55, 1.60, 1.65, 1.71, 1.76, 1.81, 1.86, 1.92, 
//							 1.97, 2.02, 2.07, 2.13, 2.18, 2.23, 2.29, 2.34, 2.39, 2.44, 2.50, 2.55, 2.60, 2.65, 2.71, 2.76, 2.81, 2.87, 2.92, 2.97, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 
//							 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 3.00, 2.99, 2.96, 2.93, 
//							 2.91, 2.88, 2.85, 2.83, 2.80, 2.77, 2.75, 2.72, 2.70, 2.67, 2.64, 2.62, 2.59, 2.56, 2.54, 2.51, 2.48, 2.46, 2.43, 2.41, 2.38, 2.35, 2.33, 2.30, 2.27, 2.25, 2.22, 2.19, 2.17, 2.14, 2.12, 2.09, 2.06, 2.04, 2.01, 1.98, 1.96, 1.93, 1.90, 1.88, 
//							 1.85, 1.83, 1.80, 1.77, 1.75, 1.72, 1.69, 1.67, 1.64, 1.61, 1.59, 1.56, 1.54, 1.51, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 
//							 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.50, 1.48, 1.45, 1.43, 1.40, 1.37, 1.35, 1.32, 1.29, 1.27, 
//							 1.24, 1.22, 1.19, 1.16, 1.14, 1.11, 1.08, 1.06, 1.03, 1.00, 0.98, 0.95, 0.93, 0.90, 0.87, 0.85, 0.82, 0.79, 0.77, 0.74, 0.71, 0.69, 0.66, 0.64, 0.61, 0.58, 0.56, 0.53, 0.50, 0.48, 0.45, 0.42, 0.40, 0.37, 0.35, 0.32, 0.29, 0.27, 0.24, 0.21, 
//							 0.19, 0.16, 0.13, 0.11, 0.08, 0.06, 0.03, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 
//							 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00};							/*	理想電流テーブル	*/

/********************		ゲート信号が適切に出力されているかを確認するときに使う		08/21/2013		********************/
float		i_ideal[1024]=	{0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.,
							 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0., 0., 5., 5., 0., 0., -5., -5., 0.};
/***************************************************************************************************************************/

float		hyswidth;

/*			各種スケール値			*/
float		i_ideal_scale;						/*	C相の電流指令値の大きさを変える	*/


/*			関数					*/
void		initialize(void);
void		error_check(void);
void		servo_switch(void);
void		behavior(void);
void		z_int(void);
void		main(void);

/*			システムの初期化			*/
void	initialize(void)
{
	/*			WAVE初期化			*/
	watch_init();
	
	/*			SRMボードの初期化				*/
	srm_init(BDN, RANGE_U, RANGE_V, RANGE_W);
	srm_set_mode(BDN, 2);
	srm_abz_clear(BDN);
	srm_abz_set_maxcount(BDN, ENC_RESOLUT/POLE_NUMBER);
	srm_ad_set_offset(BDN, OFFSET_U, OFFSET_V, OFFSET_W);
	srm_set_gate_pattern(BDN, NEG_VOLTAGE);
	srm_set_error_level(BDN, OVER_CURRENT_LEVEL);
	srm_set_hyswidth(BDN, 0.5);
	srm_set_angle_ref(BDN, 0, 341, 342, 682, 683, 1024);
	srm_set_current_ref(BDN, 5);
	
/********************		ゲート信号が適切に出力されているかを確認するときに使う		08/21/2013		********************/
	/*			DAC拡張ボードの初期化			*/
	daca_da_set_range(BDN, 0, 2048);					/*	A相のエンコーダカウント値の設定		2048カウントで10Vを出力		*/
	daca_da_set_range(BDN, 1, 2048);					/*	B相のエンコーダカウント値の設定		2048カウントで10Vを出力		*/
	daca_da_set_range(BDN, 2, 2048);					/*	C相のエンコーダカウント値の設定		2048カウントで10Vを出力		*/
	daca_da_set_range(BDN, 3, 10);					/*	A相の電流指令値の設定		10Aで10Vを出力		*/
	daca_da_set_range(BDN, 4, 10);					/*	B相の電流指令値の設定		10Aで10Vを出力		*/
	daca_da_set_range(BDN, 5, 10);					/*	C相の電流指令値の設定		10Aで10Vを出力		*/
/***************************************************************************************************************************/
	
	/*			システムの状態変数の初期化		*/
	servo_status	=	SERVO_OFF;

	/*			エンコーダ変数の初期化			*/
	enc_cnt			=	0;
	enc_cnt_a		=	0;
	enc_cnt_b		=	682.67;
	enc_cnt_c		=	341.33;
	z_det			=	0;
	z_det_comp		=	0;
	
	/*			電流指令値変数の初期化			*/
	i_ref			=	0.;
	
	/*			各種スケール値の初期化			*/
	i_ideal_scale	=	0.;

	/*			タイマー0割り込み初期化			*/
	timer0_init(TIC0);
	timer0_init_vector(behavior);
	timer0_start();
	timer0_enable_int();
	
}

/*			エラーチェック			*/
void	error_check(void)
{


	if(OVER_CURRENT == srm_get_status(BDN))
	{
		srm_stop_pwm(BDN);							/*	ゲート信号出力を禁止	*/
		servo_status	=	SERVO_OFF;					/*	サーボを停止	*/
		system_status	=	ERROR;					/*	エラーモードに移行	*/
	}
}

/*			サーボのON/OFF			*/
void	servo_switch(void)
{
	if((servo_status == SERVO_OFF)&&(system_status == RUN))
	{
		srm_start_pwm(BDN);							/*	ゲート信号出力を許可	*/
		servo_status	=	SERVO_ON;
	}
	
	if((servo_status == SERVO_ON)&&(system_status == STOP))
	{
		srm_stop_pwm(BDN);
		servo_status	=	SERVO_OFF;
	}
	
	watch_data_8ch();
}


/*			各ドライブモードの動作プログラム			*/
interrupt	void	behavior(void)
{	
	/*			多重割り込み許可（レジスタ値退避）			*/
	unsigned int regs[2];
	regs[0]	=	CSR;								/*	レジスタ値の退避	*/
	regs[1]	=	IRP;								/*	レジスタ値の退避	*/
	int_enable();									/*	多重割り込み許可	*/
	
	/*			各ドライブモードの動作プログラム			*/
	enc_cnt	=	srm_abz_read(BDN);					/*	エンコーダカウント値を取得	*/
	srm_set_hyswidth(BDN, hyswidth);				/*	ヒステリシスバンド幅を設定	*/

	
	/*			Z相検出を行うプログラム						*/
	if(drive_mode == 0)
	{
		if(z_det <= 250)							/*	A相のみを励磁		*/
		{
			u_on	=	0;
			u_off	=	1024;
			v_on	=	2000;
			v_off	=	2000;
			w_on	=	2000;
			w_off	=	2000;

			i_ref	=	2.;
			z_det	=	z_det + 1;					/*	カウントを行い，条件に応じて，特定の相を励磁	*/
		}

		else if(250 < z_det && z_det <= 590)		/*	B相のみを励磁		*/
		{
			u_on	=	2000;
			u_off	=	2000;
			v_on	=	0;
			v_off	=	1024;
			w_on	=	2000;
			w_off	=	2000;
		
			i_ref	=	2.;
			z_det	=	z_det + 1;					/*	カウントを行い，条件に応じて，特定の相を励磁	*/
		}

		else if(590 < z_det && z_det <= 885)		/*	C相のみを励磁		*/
		{
			u_on	=	2000;
			u_off	=	2000;
			v_on	=	2000;
			v_off	=	2000;
			w_on	=	0;
			w_off	=	1024;
		
			i_ref	=	2.;
			z_det	=	z_det + 1;					/*	カウントを行い，条件に応じて，特定の相を励磁	*/

			if(z_det == 885)
			{
				z_det	=	0;
			}
		}

		else if(z_det == 900)						/*	Z相割り込みを検出した場合，Z相検出を終了し，drive_modeを移行する	*/
		{
			u_on	=	0;
			u_off	=	341;
			v_on	=	342;
			v_off	=	682;
			w_on	=	683;
			w_off	=	1024;

			i_ref	=	0.;
			z_det_comp	=	1;						/*	Z相を検出したことを合図する		*/
			drive_mode	=	1;						/*	drive_modeを1に移行		*/
		}

		srm_set_current_ref(BDN, i_ref);
	}
	
	/*			電流波形成形制御プログラム					*/
	else if(drive_mode == 1)
	{
		enc_cnt_a	=	enc_cnt;					/*	取得したエンコーダカウント値をA相のカウント値として代入	*/
		enc_cnt_b	=	enc_cnt - 341.33;				/*	取得したエンコーダカウント値を電気角(1024)の1/3度ずらしてB相のカウント値として代入	*/
		enc_cnt_c	=	enc_cnt + 341.33;				/*	取得したエンコーダカウント値を電気角(1024)の1/3度ずらしてC相のカウント値として代入	*/
		
		if(enc_cnt_b < 0)
		{
			enc_cnt_b	=	enc_cnt_b + 1024;			/*	B相のカウント値が0未満の場合，電気角分(1024)を足してB相のカウント値として代入	*/
		}
		
		if(enc_cnt_c >= 1024)
		{
			enc_cnt_c	=	enc_cnt_c - 1024;			/*	B相のカウント値が電気角(1024)以上の場合，電気角(1024)分を引いてC相のカウント値として代入	*/
		}
		
		ia_ref	=	i_ideal_scale * i_ideal[enc_cnt_a];			/*	A相のカウント値をもとに，電流テーブルから電流指令値を参照し，理想電流スケール値をかけて，A相の電流指令値として代入	*/
		ib_ref	=	i_ideal_scale * i_ideal[enc_cnt_b];			/*	B相のカウント値をもとに，電流テーブルから電流指令値を参照し，理想電流スケール値をかけて，B相の電流指令値として代入	*/
		ic_ref	=	i_ideal_scale * i_ideal[enc_cnt_c];			/*	C相のカウント値をもとに，電流テーブルから電流指令値を参照し，理想電流スケール値をかけて，C相の電流指令値として代入	*/

		srm_set_current_ref2(BDN, ia_ref, ib_ref, ic_ref);		/*	各相の電流指令値の指令	*/
		
/********************		ゲート信号が適切に出力されているかを確認するときに使う		08/21/2013		********************/
		/*			DAC拡張ボードの初期化			*/
		daca_da_out(BDN, 0, enc_cnt_a);					/*	A相のエンコーダカウント値の出力	*/
		daca_da_out(BDN, 1, enc_cnt_b);					/*	B相のエンコーダカウント値の出力	*/
		daca_da_out(BDN, 2, enc_cnt_c);					/*	C相のエンコーダカウント値の出力	*/
		daca_da_out(BDN, 3, ia_ref);					/*	A相の電流指令値の出力	*/
		daca_da_out(BDN, 4, ib_ref);					/*	B相の電流指令値の出力	*/
		daca_da_out(BDN, 5, ic_ref);					/*	C相の電流指令値の出力	*/
/***************************************************************************************************************************/
	}

	/*			A相を対向させるプログラム					*/
	else if(drive_mode == 2)
	{
		u_on	=	0;
		u_off	=	1024;
		v_on	=	2000;
		v_off	=	2000;
		w_on	=	2000;
		w_off	=	2000;

		srm_set_current_ref(BDN, i_ref);
	}

	srm_set_angle_ref(BDN, u_on, u_off, v_on, v_off, w_on, w_off);			/*	励磁開始角，励磁終了角の設定	*/

	/*			多重割り込み許可（レジスタ値復元）			*/
	int_disable();									/*	多重割り込み禁止	*/
	CSR	=	regs[0];								/*	レジスタ値の復元	*/
	IRP =	regs[1];								/*	レジスタ値の復元	*/
}

void	main(void)
{
	int_disable();								/*	CPUの割り込みを禁止	*/
	initialize();								/*	システムの初期化	*/
	int_enable();								/*	CPUの割り込みを許可	*/
	
	for(;;)
	{
		error_check();							/*	エラーチェック	*/
		servo_switch();							/*	サーボのON/OFF	*/

		if(Exp_start == 0)
		{
			system_status	=	STOP;
		}
		else if(Exp_start == 1)
		{
			system_status	=	RUN;
		}
		
		watch_data();
	}
}
